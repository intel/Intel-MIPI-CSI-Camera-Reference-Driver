From ea56f3f2c08dc6ef45ff26221f92f45562b149b9 Mon Sep 17 00:00:00 2001
From: Dongcheng Yan <dongcheng.yan@intel.com>
Date: Mon, 12 Jan 2026 08:06:36 -0700
Subject: [PATCH 20/28] upstream: Use module parameter to set psys freq

---
 6.12.0/drivers/media/pci/intel/ipu6/ipu6.c | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/6.12.0/drivers/media/pci/intel/ipu6/ipu6.c b/6.12.0/drivers/media/pci/intel/ipu6/ipu6.c
index 5684dac..c9513c5 100644
--- a/6.12.0/drivers/media/pci/intel/ipu6/ipu6.c
+++ b/6.12.0/drivers/media/pci/intel/ipu6/ipu6.c
@@ -51,6 +51,10 @@ static unsigned int isys_freq_override;
 module_param(isys_freq_override, uint, 0660);
 MODULE_PARM_DESC(isys_freq_override, "Override ISYS freq(mhz)");
 
+static unsigned int psys_freq_override;
+module_param(psys_freq_override, uint, 0660);
+MODULE_PARM_DESC(psys_freq_override, "Override PSYS freq(mhz)");
+
 #define IPU6_PCI_BAR		0
 
 struct ipu6_cell_program {
@@ -482,6 +486,15 @@ ipu6_psys_init(struct pci_dev *pdev, struct device *parent,
 	pdata->base = base;
 	pdata->ipdata = ipdata;
 
+	/* Override the isys freq */
+	if (psys_freq_override >= BUTTRESS_MIN_FORCE_PS_FREQ &&
+	    psys_freq_override <= BUTTRESS_MAX_FORCE_PS_FREQ) {
+		ctrl->ratio = psys_freq_override / BUTTRESS_PS_FREQ_STEP;
+		ctrl->qos_floor = psys_freq_override;
+		dev_dbg(&pdev->dev, "Override the psys freq:%u(mhz)\n",
+			psys_freq_override);
+	}
+
 	psys_adev = ipu6_bus_initialize_device(pdev, parent, pdata, ctrl,
 					       IPU6_PSYS_NAME);
 	if (IS_ERR(psys_adev)) {
-- 
2.43.0

