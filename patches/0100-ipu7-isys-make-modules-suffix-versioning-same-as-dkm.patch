From 70b32b4340d7beb67ef59951ccac07c555de6903 Mon Sep 17 00:00:00 2001
From: Florent Pirou <florent.pirou@intel.com>
Date: Sat, 17 Jan 2026 02:10:39 -0700
Subject: [PATCH 100/104] ipu7-isys: make modules suffix versioning same as
 dkms

Signed-off-by: Florent Pirou <florent.pirou@intel.com>
---
 ipu7-drivers/drivers/media/pci/intel/ipu7/Makefile   | 12 ++++++++++++
 .../drivers/media/pci/intel/ipu7/ipu7-isys.c         |  1 +
 ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7.c     |  1 +
 .../drivers/media/pci/intel/ipu7/psys/ipu-psys.c     |  1 +
 4 files changed, 15 insertions(+)

diff --git a/ipu7-drivers/drivers/media/pci/intel/ipu7/Makefile b/ipu7-drivers/drivers/media/pci/intel/ipu7/Makefile
index 5041701..754d4e8 100644
--- a/ipu7-drivers/drivers/media/pci/intel/ipu7/Makefile
+++ b/ipu7-drivers/drivers/media/pci/intel/ipu7/Makefile
@@ -1,5 +1,15 @@
 # SPDX-License-Identifier: GPL-2.0
 # Copyright (c) 2017 - 2025 Intel Corporation.
+KERNEL_VERSION := $(shell echo $(KERNELRELEASE) | sed 's/[^0-9.]*\([0-9]\.[0-9]*\)\..*/\1.0/')
+
+CC := ${CC} -I ${M}/../../../../../../include -I ${M}/../../../../../../$(KERNEL_VERSION)/include-overrides -DCONFIG_DEBUG_FS -DCONFIG_INTEL_IPU_ACPI -DCONFIG_VIDEO_INTEL_IPU7_ISYS_RESET -DCONFIG_VIDEO_INTEL_IPU7_EXT_CTRLS
+
+KBUILD_EXTRA_SYMBOLS += ${M}/../../../../../../Module.symvers
+
+ccflags-y += -DDRIVER_VERSION_SUFFIX=\"${DRIVER_VERSION_SUFFIX}\"
+
+export EXTERNAL_BUILD = 1
+export CONFIG_VIDEO_INTEL_IPU7=m
 
 is_kernel_lt_6_10 = $(shell if [ $$(printf "6.10\n$(KERNELVERSION)" | sort -V | head -n1) != "6.10" ]; then echo 1; fi)
 ifeq ($(is_kernel_lt_6_10), 1)
@@ -32,6 +42,8 @@ intel-ipu7-isys-objs                    += ipu7-isys-tpg.o
 endif
 obj-$(CONFIG_VIDEO_INTEL_IPU7)		+= intel-ipu7-isys.o
 
+subdir-ccflags-y += -DDRIVER_VERSION_SUFFIX=\"${DRIVER_VERSION_SUFFIX}\"
+
 obj-$(CONFIG_VIDEO_INTEL_IPU7)		+= psys/
 
 ccflags-y += -I$(src)/
diff --git a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys.c b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys.c
index 00edeeb..301c101 100644
--- a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys.c
+++ b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys.c
@@ -1501,3 +1501,4 @@ MODULE_IMPORT_NS("INTEL_IPU_BRIDGE");
 MODULE_IMPORT_NS(INTEL_IPU7);
 MODULE_IMPORT_NS(INTEL_IPU_BRIDGE);
 #endif
+MODULE_VERSION(DRIVER_VERSION_SUFFIX);
diff --git a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7.c b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7.c
index 80d5fda..e1fafe3 100644
--- a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7.c
+++ b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7.c
@@ -2878,3 +2878,4 @@ MODULE_AUTHOR("Qingwu Zhang <qingwu.zhang@intel.com>");
 MODULE_AUTHOR("Intel");
 MODULE_LICENSE("GPL");
 MODULE_DESCRIPTION("Intel ipu7 pci driver");
+MODULE_VERSION(DRIVER_VERSION_SUFFIX);
diff --git a/ipu7-drivers/drivers/media/pci/intel/ipu7/psys/ipu-psys.c b/ipu7-drivers/drivers/media/pci/intel/ipu7/psys/ipu-psys.c
index 838f0b2..b5ff06a 100644
--- a/ipu7-drivers/drivers/media/pci/intel/ipu7/psys/ipu-psys.c
+++ b/ipu7-drivers/drivers/media/pci/intel/ipu7/psys/ipu-psys.c
@@ -1554,3 +1554,4 @@ MODULE_IMPORT_NS("DMA_BUF");
 MODULE_IMPORT_NS(INTEL_IPU7);
 MODULE_IMPORT_NS(DMA_BUF);
 #endif
+MODULE_VERSION(DRIVER_VERSION_SUFFIX);
-- 
2.43.0

