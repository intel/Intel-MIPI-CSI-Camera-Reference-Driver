From 1fcc1dad44343b80e60841e03cff411ee41d9a5b Mon Sep 17 00:00:00 2001
From: Florent Pirou <florent.pirou@intel.com>
Date: Sat, 17 Jan 2026 02:08:28 -0700
Subject: [PATCH 102/104] ipu7-isys : add d4xx pixel format support

Signed-off-by: Florent Pirou <florent.pirou@intel.com>
---
 .../drivers/media/pci/intel/ipu7/abi/ipu7_fw_isys_abi.h  | 1 +
 .../drivers/media/pci/intel/ipu7/ipu7-isys-csi2.c        | 3 +++
 .../drivers/media/pci/intel/ipu7/ipu7-isys-subdev.c      | 3 +++
 .../drivers/media/pci/intel/ipu7/ipu7-isys-video.c       | 9 +++++++++
 ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys.h    | 4 ++--
 5 files changed, 18 insertions(+), 2 deletions(-)

diff --git a/ipu7-drivers/drivers/media/pci/intel/ipu7/abi/ipu7_fw_isys_abi.h b/ipu7-drivers/drivers/media/pci/intel/ipu7/abi/ipu7_fw_isys_abi.h
index dc63449..9abf8d1 100644
--- a/ipu7-drivers/drivers/media/pci/intel/ipu7/abi/ipu7_fw_isys_abi.h
+++ b/ipu7-drivers/drivers/media/pci/intel/ipu7/abi/ipu7_fw_isys_abi.h
@@ -125,6 +125,7 @@ enum ipu7_insys_frame_format_type {
 	IPU_INSYS_FRAME_FORMAT_ARGB888 = 31,
 	IPU_INSYS_FRAME_FORMAT_BGRA888 = 32,
 	IPU_INSYS_FRAME_FORMAT_ABGR888 = 33,
+	IPU_INSYS_FRAME_FORMAT_VYUY = 34,
 	N_IPU_INSYS_FRAME_FORMAT
 };
 
diff --git a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys-csi2.c b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys-csi2.c
index 0c931a7..88b12f5 100644
--- a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys-csi2.c
+++ b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys-csi2.c
@@ -28,11 +28,13 @@
 #include "ipu7-isys-csi-phy.h"
 
 static const u32 csi2_supported_codes[] = {
+	MEDIA_BUS_FMT_Y8_1X8,
 	MEDIA_BUS_FMT_Y10_1X10,
 	MEDIA_BUS_FMT_RGB565_1X16,
 	MEDIA_BUS_FMT_RGB888_1X24,
 	MEDIA_BUS_FMT_UYVY8_1X16,
 	MEDIA_BUS_FMT_YUYV8_1X16,
+	MEDIA_BUS_FMT_VYUY8_1X16,
 	MEDIA_BUS_FMT_YUYV10_1X20,
 	MEDIA_BUS_FMT_SBGGR10_1X10,
 	MEDIA_BUS_FMT_SGBRG10_1X10,
@@ -46,6 +48,7 @@ static const u32 csi2_supported_codes[] = {
 	MEDIA_BUS_FMT_SGBRG8_1X8,
 	MEDIA_BUS_FMT_SGRBG8_1X8,
 	MEDIA_BUS_FMT_SRGGB8_1X8,
+	MEDIA_BUS_FMT_FIXED,
 	0,
 };
 
diff --git a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys-subdev.c b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys-subdev.c
index 98b6ef6..b99b5e9 100644
--- a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys-subdev.c
+++ b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys-subdev.c
@@ -19,6 +19,7 @@
 #include "ipu7-isys.h"
 #include "ipu7-isys-subdev.h"
 
+
 unsigned int ipu7_isys_mbus_code_to_mipi(u32 code)
 {
 	switch (code) {
@@ -30,6 +31,7 @@ unsigned int ipu7_isys_mbus_code_to_mipi(u32 code)
 		return MIPI_CSI2_DT_YUV422_10B;
 	case MEDIA_BUS_FMT_UYVY8_1X16:
 	case MEDIA_BUS_FMT_YUYV8_1X16:
+	case MEDIA_BUS_FMT_VYUY8_1X16:
 		return MIPI_CSI2_DT_YUV422_8B;
 	case MEDIA_BUS_FMT_SBGGR12_1X12:
 	case MEDIA_BUS_FMT_SGBRG12_1X12:
@@ -42,6 +44,7 @@ unsigned int ipu7_isys_mbus_code_to_mipi(u32 code)
 	case MEDIA_BUS_FMT_SGRBG10_1X10:
 	case MEDIA_BUS_FMT_SRGGB10_1X10:
 		return MIPI_CSI2_DT_RAW10;
+	case MEDIA_BUS_FMT_Y8_1X8:
 	case MEDIA_BUS_FMT_SBGGR8_1X8:
 	case MEDIA_BUS_FMT_SGBRG8_1X8:
 	case MEDIA_BUS_FMT_SGRBG8_1X8:
diff --git a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys-video.c b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys-video.c
index de3ebf9..44aa17c 100644
--- a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys-video.c
+++ b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys-video.c
@@ -83,12 +83,21 @@ const struct ipu7_isys_pixelformat ipu7_isys_pfmts[] = {
 	 IPU_INSYS_FRAME_FORMAT_RAW10},
 	{V4L2_PIX_FMT_UYVY, 16, 16, MEDIA_BUS_FMT_UYVY8_1X16,
 	 IPU_INSYS_FRAME_FORMAT_UYVY},
+	{V4L2_PIX_FMT_Z16, 16, 16, MEDIA_BUS_FMT_UYVY8_1X16,
+	 IPU_INSYS_FRAME_FORMAT_UYVY},
 	{V4L2_PIX_FMT_YUYV, 16, 16, MEDIA_BUS_FMT_YUYV8_1X16,
 	 IPU_INSYS_FRAME_FORMAT_YUYV},
+	{V4L2_PIX_FMT_Y8I, 16, 16, MEDIA_BUS_FMT_VYUY8_1X16,
+	 IPU_INSYS_FRAME_FORMAT_YUYV},
 	{V4L2_PIX_FMT_RGB565, 16, 16, MEDIA_BUS_FMT_RGB565_1X16,
 	 IPU_INSYS_FRAME_FORMAT_RGB565},
 	{V4L2_PIX_FMT_BGR24, 24, 24, MEDIA_BUS_FMT_RGB888_1X24,
 	 IPU_INSYS_FRAME_FORMAT_RGBA888},
+	{V4L2_PIX_FMT_Y12I, 32, 24, MEDIA_BUS_FMT_RGB888_1X24,
+	 IPU_INSYS_FRAME_FORMAT_RGBA888},
+	{V4L2_PIX_FMT_GREY, 8, 8, MEDIA_BUS_FMT_Y8_1X8,
+	 IPU_INSYS_FRAME_FORMAT_RAW8},
+	{V4L2_META_FMT_D4XX, 8, 8, MEDIA_BUS_FMT_FIXED, 0},
 };
 
 static int video_open(struct file *file)
diff --git a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys.h b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys.h
index 2e45258..19eea94 100644
--- a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys.h
+++ b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys.h
@@ -43,8 +43,8 @@ struct dentry;
 #define IPU_ISYS_SIZE_SEND_QUEUE	40U
 #define IPU_ISYS_NUM_RECV_QUEUE		1U
 
-#define IPU_ISYS_MIN_WIDTH		2U
-#define IPU_ISYS_MIN_HEIGHT		2U
+#define IPU_ISYS_MIN_WIDTH		1U
+#define IPU_ISYS_MIN_HEIGHT		1U
 #define IPU_ISYS_MAX_WIDTH		8160U
 #define IPU_ISYS_MAX_HEIGHT		8190U
 
-- 
2.43.0

