From 3fa91bddbefdfabb8c1510df9c3eb85f9688467f Mon Sep 17 00:00:00 2001
From: Florent Pirou <florent.pirou@intel.com>
Date: Sat, 17 Jan 2026 01:54:42 -0700
Subject: [PATCH 100/104] ipu-acpi: decouple the PLATFORM ACPI driver and IPU
 driver

Signed-off-by: Florent Pirou <florent.pirou@intel.com>
---
 ipu7-drivers/Makefile                         |  6 +-
 .../drivers/media/pci/intel/ipu7/ipu7-isys.c  |  8 +--
 .../drivers/media/pci/intel/ipu7/ipu7.c       |  8 +--
 .../drivers/media/platform/intel/Kconfig      |  2 +-
 .../drivers/media/platform/intel/Makefile     |  6 +-
 .../media/platform/intel/ipu-acpi-common.c    |  9 ++-
 .../media/platform/intel/ipu-acpi-pdata.c     | 57 ++++++++++-----
 .../drivers/media/platform/intel/ipu-acpi.c   | 61 +++++++++++++---
 ipu7-drivers/include/media/ipu-acpi-pdata.h   |  7 +-
 ipu7-drivers/include/media/ipu-acpi.h         | 70 ++++++++++++++++---
 10 files changed, 177 insertions(+), 57 deletions(-)

diff --git a/ipu7-drivers/Makefile b/ipu7-drivers/Makefile
index deb1761..ee53758 100644
--- a/ipu7-drivers/Makefile
+++ b/ipu7-drivers/Makefile
@@ -8,7 +8,7 @@ MODSRC := $(shell pwd)
 export EXTERNAL_BUILD = 1
 export CONFIG_VIDEO_INTEL_IPU7 = m
 export CONFIG_IPU_BRIDGE = y
-export CONFIG_INTEL_IPU7_ACPI = m
+export CONFIG_INTEL_IPU_ACPI = m
 
 obj-y += drivers/media/pci/intel/ipu7/
 obj-y += drivers/media/platform/intel/
@@ -16,8 +16,8 @@ subdir-ccflags-y += -I$(src)/include
 
 subdir-ccflags-$(CONFIG_IPU_BRIDGE) += \
 	-DCONFIG_IPU_BRIDGE
-subdir-ccflags-$(CONFIG_INTEL_IPU7_ACPI) += \
-	-DCONFIG_INTEL_IPU7_ACPI
+subdir-ccflags-$(CONFIG_INTEL_IPU_ACPI) += \
+	-DCONFIG_INTEL_IPU_ACPI
 subdir-ccflags-y += $(subdir-ccflags-m)
 
 all:
diff --git a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys.c b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys.c
index ed3e37b..767104d 100644
--- a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys.c
+++ b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7-isys.c
@@ -178,7 +178,7 @@ static int isys_register_ext_subdev(struct ipu7_isys *isys,
 	client = isys_find_i2c_subdev(adapter, sd_info);
 	if (client) {
 		dev_warn(dev, "Device exists\n");
-#if IS_ENABLED(CONFIG_INTEL_IPU7_ACPI)
+#if IS_ENABLED(CONFIG_INTEL_IPU_ACPI)
 		/* TODO: remove i2c_unregister_device() */
 		i2c_unregister_device(client);
 #else
@@ -266,7 +266,7 @@ static int isys_fw_log_init(struct ipu7_isys *isys)
 	return 0;
 }
 
-#if IS_ENABLED(CONFIG_INTEL_IPU7_ACPI)
+#if IS_ENABLED(CONFIG_INTEL_IPU_ACPI)
 /* The .bound() notifier callback when a match is found */
 static int isys_notifier_bound(struct v4l2_async_notifier *notifier,
 			       struct v4l2_subdev *sd,
@@ -580,7 +580,7 @@ static int isys_tpg_create_media_links(struct ipu7_isys *isys)
 
 #endif
 
-#if IS_ENABLED(CONFIG_INTEL_IPU7_ACPI)
+#if IS_ENABLED(CONFIG_INTEL_IPU_ACPI)
 static int isys_register_devices(struct ipu7_isys *isys)
 {
 	struct device *dev = &isys->adev->auxdev.dev;
@@ -875,7 +875,7 @@ static const struct dev_pm_ops isys_pm_ops = {
 	.resume = isys_resume,
 };
 
-#if IS_ENABLED(CONFIG_INTEL_IPU7_ACPI)
+#if IS_ENABLED(CONFIG_INTEL_IPU_ACPI)
 static void isys_remove(struct auxiliary_device *auxdev)
 {
 	struct ipu7_isys *isys = dev_get_drvdata(&auxdev->dev);
diff --git a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7.c b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7.c
index 20c88d5..96c3d2c 100644
--- a/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7.c
+++ b/ipu7-drivers/drivers/media/pci/intel/ipu7/ipu7.c
@@ -40,8 +40,8 @@
 #include "ipu7-mmu.h"
 #include "ipu7-platform-regs.h"
 
-#if IS_ENABLED(CONFIG_INTEL_IPU7_ACPI)
-#include <media/ipu-acpi.h>
+#if IS_ENABLED(CONFIG_INTEL_IPU_ACPI)
+#include <media/ipu-get-acpi.h>
 
 #endif
 #define IPU_PCI_BAR		0
@@ -2626,8 +2626,8 @@ static int ipu7_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)
 		goto out_ipu_bus_del_devices;
 	}
 
-#if IS_ENABLED(CONFIG_INTEL_IPU7_ACPI)
-	ipu_get_acpi_devices(&dev->platform_data);
+#if IS_ENABLED(CONFIG_INTEL_IPU_ACPI)
+	ipu_get_acpi_devices_new(&dev->platform_data);
 #endif
 	isp->isys = ipu7_isys_init(pdev, dev, isys_ctrl, isys_base,
 				   dev->platform_data,
diff --git a/ipu7-drivers/drivers/media/platform/intel/Kconfig b/ipu7-drivers/drivers/media/platform/intel/Kconfig
index f8affa6..b8a7a36 100644
--- a/ipu7-drivers/drivers/media/platform/intel/Kconfig
+++ b/ipu7-drivers/drivers/media/platform/intel/Kconfig
@@ -8,7 +8,7 @@ config INTEL_IPU7_FPGA_PDATA
 	development and mainly used for pixter or sensor enablement
 	without ACPI support.
 
-config INTEL_IPU7_ACPI
+config INTEL_IPU_ACPI
 	tristate "Enable IPU ACPI driver"
 	default VIDEO_INTEL_IPU7
 	depends on I2C
diff --git a/ipu7-drivers/drivers/media/platform/intel/Makefile b/ipu7-drivers/drivers/media/platform/intel/Makefile
index d0c41b7..409d55c 100644
--- a/ipu7-drivers/drivers/media/platform/intel/Makefile
+++ b/ipu7-drivers/drivers/media/platform/intel/Makefile
@@ -1,5 +1,5 @@
 # SPDX-License-Identifier: GPL-2.0
-# Copyright (c) 2010 - 2022 Intel Corporation.
+# Copyright (c) 2010 - 2025 Intel Corporation.
 
 is_kernel_lt_6_10 = $(shell if [ $$(printf "6.10\n$(KERNELVERSION)" | sort -V | head -n1) != "6.10" ]; then echo 1; fi)
 ifeq ($(is_kernel_lt_6_10), 1)
@@ -10,8 +10,8 @@ endif
 
 ccflags-y += -I$(src)/../../pci/intel/ipu7/
 
-ifneq ($(filter y m, $(CONFIG_INTEL_IPU7_ACPI)),)
-obj-$(CONFIG_INTEL_IPU7_ACPI) += ipu-acpi.o \
+ifneq ($(filter y m, $(CONFIG_INTEL_IPU_ACPI)),)
+obj-$(CONFIG_INTEL_IPU_ACPI) += ipu-acpi.o \
                                  ipu-acpi-pdata.o \
                                  ipu-acpi-common.o
 else
diff --git a/ipu7-drivers/drivers/media/platform/intel/ipu-acpi-common.c b/ipu7-drivers/drivers/media/platform/intel/ipu-acpi-common.c
index 936c158..1804932 100644
--- a/ipu7-drivers/drivers/media/platform/intel/ipu-acpi-common.c
+++ b/ipu7-drivers/drivers/media/platform/intel/ipu-acpi-common.c
@@ -1,6 +1,6 @@
 // SPDX-License-Identifier: GPL-2.0
 /*
- * Copyright (c) 2016-2024 Intel Corporation.
+ * Copyright (c) 2016-2025 Intel Corporation.
  *
  * This program is free software; you can redistribute it and/or
  * modify it under the terms of the GNU General Public License version
@@ -13,7 +13,10 @@
  *
  */
 #include <linux/platform_device.h>
+#include <linux/pci.h>
 #include <linux/version.h>
+#include <linux/gpio/consumer.h>
+
 #include <media/ipu-acpi-pdata.h>
 #include <media/ipu-acpi.h>
 
@@ -365,8 +368,12 @@ int ipu_acpi_get_dep_data(struct device *dev,
 			continue;
 
 		/* Process device IN3472 created by acpi */
+#if LINUX_VERSION_CODE < KERNEL_VERSION(5, 17, 0)
+		if (acpi_bus_get_device(dep_devices.handles[i], &device)) {
+#else
 		device = acpi_fetch_acpi_dev(dep_devices.handles[i]);
 		if (!device) {
+#endif
 			pr_err("IPU ACPI: Failed to get ACPI device");
 			return -ENODEV;
 		}
diff --git a/ipu7-drivers/drivers/media/platform/intel/ipu-acpi-pdata.c b/ipu7-drivers/drivers/media/platform/intel/ipu-acpi-pdata.c
index 0a84dcc..be75bb4 100644
--- a/ipu7-drivers/drivers/media/platform/intel/ipu-acpi-pdata.c
+++ b/ipu7-drivers/drivers/media/platform/intel/ipu-acpi-pdata.c
@@ -12,18 +12,31 @@
  * GNU General Public License for more details.
  *
  */
-
 #include <media/ipu-acpi.h>
 #include <media/ipu-acpi-pdata.h>
 
 #define MIN_SENSOR_I2C 1
 #define MIN_SERDES_I2C 3
 #define SUFFIX_BASE 97
+#define MSG_LEN 128
 
-struct ipu7_isys_subdev_pdata acpi_subdev_pdata = {
-	.subdevs = (struct ipu7_isys_subdev_info *[]) {
-		NULL,
-	}
+static struct ipu_isys_subdev_pdata *ptr_built_in_pdata;
+
+void set_built_in_pdata(struct ipu_isys_subdev_pdata *pdata)
+{
+	ptr_built_in_pdata = pdata;
+};
+EXPORT_SYMBOL(set_built_in_pdata);
+
+static struct ipu_isys_clk_mapping clk_mapping[] = {
+	{ CLKDEV_INIT(NULL, NULL, NULL), NULL }
+};
+
+struct ipu_isys_subdev_pdata acpi_subdev_pdata = {
+	.subdevs = (struct ipu_isys_subdev_info *[]) {
+		NULL, NULL, NULL, NULL, NULL,
+	},
+	.clk_map = clk_mapping,
 };
 
 struct serdes_local serdes_info;
@@ -74,7 +87,8 @@ static int get_i2c_bus_id(int adapter_id, char *adapter_bdf, int bdf_len)
  */
 static void update_i2c_bus_id(void)
 {
-	struct ipu7_isys_subdev_info **subdevs = acpi_subdev_pdata.subdevs;
+	struct ipu_isys_subdev_info **subdevs = acpi_subdev_pdata.subdevs;
+
 	for (int i = 0; subdevs[i] != NULL; i++) {
 		subdevs[i]->i2c.i2c_adapter_id =
 			get_i2c_bus_id(subdevs[i]->i2c.i2c_adapter_id,
@@ -83,9 +97,9 @@ static void update_i2c_bus_id(void)
 	}
 }
 
-struct ipu7_isys_subdev_pdata *get_acpi_subdev_pdata(void)
+struct ipu_isys_subdev_pdata *get_acpi_subdev_pdata(void)
 {
-	struct ipu7_isys_subdev_pdata *ptr;
+	struct ipu_isys_subdev_pdata *ptr;
 
 	update_i2c_bus_id();
 	ptr = &acpi_subdev_pdata;
@@ -122,7 +136,7 @@ static void print_serdes_sdinfo(struct serdes_subdev_info *sdinfo)
 				(int)sd_mpdata->gpio_powerup_seq[i]);
 }
 
-static void print_serdes_subdev(struct ipu7_isys_subdev_info *sd)
+static void print_serdes_subdev(struct ipu_isys_subdev_info *sd)
 {
 	struct serdes_platform_data *sd_pdata = sd->i2c.board_info.platform_data;
 	int i;
@@ -153,6 +167,7 @@ static void print_serdes_subdev(struct ipu7_isys_subdev_info *sd)
 	pr_debug("\t\tlink_freq_mbps \t\t= %d", sd_pdata->link_freq_mbps);
 	pr_debug("\t\tdeser_nlanes \t\t= %d", sd_pdata->deser_nlanes);
 	pr_debug("\t\tser_nlanes \t\t= %d", sd_pdata->ser_nlanes);
+	pr_debug("\t\tser_name \t\t= %s", sd_pdata->ser_name);
 
 	for (i = 0; i < serdes_info.rx_port; i++) {
 		sd_sdinfo = &sd_pdata->subdev_info[i];
@@ -167,7 +182,7 @@ static void print_serdes_subdev(struct ipu7_isys_subdev_info *sd)
 
 }
 
-static void print_subdev(struct ipu7_isys_subdev_info *sd)
+static void print_subdev(struct ipu_isys_subdev_info *sd)
 {
 	struct sensor_platform_data *spdata = sd->i2c.board_info.platform_data;
 	int i;
@@ -198,7 +213,7 @@ static void print_subdev(struct ipu7_isys_subdev_info *sd)
 	pr_debug("\t\treset_pin \t\t= %d", spdata->reset_pin);
 	pr_debug("\t\tdetect_pin \t\t= %d", spdata->detect_pin);
 
-	for (i = 0; i < IPU7_SPDATA_GPIO_NUM; i++)
+	for (i = 0; i < IPU_SPDATA_GPIO_NUM; i++)
 		pr_debug("\t\tgpios[%d] \t\t= %d", i, spdata->gpios[i]);
 }
 
@@ -226,11 +241,11 @@ static void set_common_gpio(struct control_logic_data *ctl_data,
 					ctl_data->gpio[i].func);
 }
 
-static int set_csi2(struct ipu7_isys_subdev_info **sensor_sd,
+static int set_csi2(struct ipu_isys_subdev_info **sensor_sd,
 		    unsigned int lanes, unsigned int port,
 		    unsigned int bus_type)
 {
-	struct ipu7_isys_csi2_config *csi2_config;
+	struct ipu_isys_csi2_config *csi2_config;
 
 	csi2_config = kzalloc(sizeof(*csi2_config), GFP_KERNEL);
 	if (!csi2_config)
@@ -250,7 +265,7 @@ static int set_csi2(struct ipu7_isys_subdev_info **sensor_sd,
 	return 0;
 }
 
-static void set_i2c(struct ipu7_isys_subdev_info **sensor_sd,
+static void set_i2c(struct ipu_isys_subdev_info **sensor_sd,
 		struct device *dev,
 		const char *sensor_name,
 		unsigned int addr,
@@ -274,7 +289,7 @@ static void set_serdes_sd_pdata(struct serdes_module_pdata **module_pdata,
 
 #define PORT_NR 8
 
-static int set_serdes_subdev(struct ipu7_isys_subdev_info **serdes_sd,
+static int set_serdes_subdev(struct ipu_isys_subdev_info **serdes_sd,
 		struct device *dev,
 		struct serdes_platform_data **pdata,
 		const char *sensor_name,
@@ -305,6 +320,7 @@ static int set_serdes_subdev(struct ipu7_isys_subdev_info **serdes_sd,
 		/* board info */
 		strscpy(serdes_sdinfo[i].board_info.type, sensor_name, I2C_NAME_SIZE);
 		serdes_sdinfo[i].board_info.addr = serdes_info.sensor_map_addr + i;
+
 		serdes_sdinfo[i].board_info.platform_data = module_pdata[i];
 
 		/* serdes_subdev_info */
@@ -326,7 +342,7 @@ static int set_serdes_subdev(struct ipu7_isys_subdev_info **serdes_sd,
 	return 0;
 }
 
-static int set_pdata(struct ipu7_isys_subdev_info **sensor_sd,
+static int set_pdata(struct ipu_isys_subdev_info **sensor_sd,
 		struct device *dev,
 		const char *sensor_name,
 		const char *hid_name,
@@ -423,7 +439,7 @@ static void set_serdes_info(struct device *dev, const char *sensor_name,
 }
 
 static int populate_sensor_pdata(struct device *dev,
-			struct ipu7_isys_subdev_info **sensor_sd,
+			struct ipu_isys_subdev_info **sensor_sd,
 			struct sensor_bios_data *cam_data,
 			struct control_logic_data *ctl_data,
 			enum connection_type connect,
@@ -433,7 +449,7 @@ static int populate_sensor_pdata(struct device *dev,
 			int sensor_physical_addr,
 			int link_freq)
 {
-	struct ipu7_isys_subdev_pdata *ptr_acpi_subdev_pdata = &acpi_subdev_pdata;
+	struct ipu_isys_subdev_pdata *ptr_acpi_subdev_pdata = &acpi_subdev_pdata;
 	int i = 0;
 	int ret;
 
@@ -453,6 +469,7 @@ static int populate_sensor_pdata(struct device *dev,
 				cam_data->i2c_num);
 			return -1;
 		}
+
 		/* Others use DISCRETE Control Logic */
 		if (ctl_data->type != CL_DISCRETE) {
 			dev_err(dev, "IPU ACPI: Control Logic Type\n");
@@ -530,12 +547,13 @@ int get_sensor_pdata(struct device *dev,
 {
 	struct sensor_bios_data *cam_data;
 	struct control_logic_data *ctl_data;
-	struct ipu7_isys_subdev_info *sensor_sd;
+	struct ipu_isys_subdev_info *sensor_sd;
 	int rval;
 
 	cam_data = kzalloc(sizeof(*cam_data), GFP_KERNEL);
 	if (!cam_data)
 		return -ENOMEM;
+
 	cam_data->dev = dev;
 
 	ctl_data = kzalloc(sizeof(*ctl_data), GFP_KERNEL);
@@ -543,6 +561,7 @@ int get_sensor_pdata(struct device *dev,
 		kfree(cam_data);
 		return -ENOMEM;
 	}
+
 	ctl_data->dev = dev;
 
 	sensor_sd = kzalloc(sizeof(*sensor_sd), GFP_KERNEL);
diff --git a/ipu7-drivers/drivers/media/platform/intel/ipu-acpi.c b/ipu7-drivers/drivers/media/platform/intel/ipu-acpi.c
index deed3bb..a5a54b4 100644
--- a/ipu7-drivers/drivers/media/platform/intel/ipu-acpi.c
+++ b/ipu7-drivers/drivers/media/platform/intel/ipu-acpi.c
@@ -32,6 +32,8 @@
 #include <linux/clkdev.h>
 #include <linux/kernel.h>
 #include <linux/pci.h>
+#include <linux/version.h>
+
 #include <media/ipu-acpi-pdata.h>
 #include <media/ipu-acpi.h>
 
@@ -73,7 +75,7 @@ static const struct ipu_acpi_devices supported_devices[] = {
 
 static int get_table_index(const char *acpi_name)
 {
-	unsigned int i;
+	int i;
 
 	for (i = 0; i < ARRAY_SIZE(supported_devices); i++) {
 		if (!strncmp(supported_devices[i].hid_name, acpi_name,
@@ -143,8 +145,8 @@ static int ipu_acpi_test(struct device *dev, void *priv)
 
 	if (acpi_idx < 0)
 		return 0;
-	else
-		dev_info(dev, "IPU6 ACPI: ACPI device %s\n", dev_name(dev));
+
+	dev_info(dev, "IPU6 ACPI: ACPI device %s\n", dev_name(dev));
 
 	const char *target_hid = supported_devices[acpi_idx].hid_name;
 
@@ -161,10 +163,10 @@ static int ipu_acpi_test(struct device *dev, void *priv)
 		if (!adev) {
 			dev_dbg(dev, "No ACPI device found for %s\n", target_hid);
 			return 0;
-		} else {
-			set_primary_fwnode(dev, &adev->fwnode);
-			dev_dbg(dev, "Assigned fwnode to %s\n", dev_name(dev));
 		}
+
+		set_primary_fwnode(dev, &adev->fwnode);
+		dev_dbg(dev, "Assigned fwnode to %s\n", dev_name(dev));
 	}
 
 	if (ACPI_COMPANION(dev) != adev) {
@@ -185,15 +187,53 @@ static int ipu_acpi_test(struct device *dev, void *priv)
 	return 0; /* Continue iteration */
 }
 
+/* Scan all i2c devices and pick ones which we can handle */
+
 /* Try to get all IPU related devices mentioned in BIOS and all related information
- * return a new generated existing pdata
+ * If there is existing ipu_isys_subdev_pdata, update the existing pdata
+ * If not, return a new generated existing pdata
  */
 
-int ipu_get_acpi_devices(void **spdata)
+int ipu_get_acpi_devices(void *driver_data,
+				struct device *dev,
+				void **spdata,
+				void **built_in_pdata,
+				int (*fn)
+				(struct device *, void *,
+				 void *csi2,
+				 bool reprobe))
 {
 	struct ipu_i2c_helper helper = {0};
 	int rval;
-	struct ipu7_isys_subdev_pdata *ptr = NULL;
+
+	if (!built_in_pdata)
+		dev_dbg(dev, "Built-in pdata not found");
+	else {
+		dev_dbg(dev, "Built-in pdata found");
+		set_built_in_pdata(*built_in_pdata);
+	}
+
+	if ((!fn) || (!driver_data))
+		return -ENODEV;
+
+	rval = acpi_bus_for_each_dev(ipu_acpi_test, NULL);
+	if (rval < 0)
+		return rval;
+
+	if (!built_in_pdata) {
+		dev_dbg(dev, "Return ACPI generated pdata");
+		*spdata = get_acpi_subdev_pdata();
+	} else
+		dev_dbg(dev, "Return updated built-in pdata");
+
+	return 0;
+}
+EXPORT_SYMBOL(ipu_get_acpi_devices);
+
+int ipu_get_acpi_devices_new(void **spdata)
+{
+	int rval;
+	struct ipu_isys_subdev_pdata *ptr = NULL;
 
 	rval = acpi_bus_for_each_dev(ipu_acpi_test, NULL);
 	if (rval < 0)
@@ -205,10 +245,11 @@ int ipu_get_acpi_devices(void **spdata)
 
 	return 0;
 }
-EXPORT_SYMBOL(ipu_get_acpi_devices);
+EXPORT_SYMBOL(ipu_get_acpi_devices_new);
 
 static int __init ipu_acpi_init(void)
 {
+	set_built_in_pdata(NULL);
 	return 0;
 }
 
diff --git a/ipu7-drivers/include/media/ipu-acpi-pdata.h b/ipu7-drivers/include/media/ipu-acpi-pdata.h
index e207441..c6ec18e 100644
--- a/ipu7-drivers/include/media/ipu-acpi-pdata.h
+++ b/ipu7-drivers/include/media/ipu-acpi-pdata.h
@@ -9,6 +9,7 @@
 
 #define CL_EMPTY 0
 #define CL_DISCRETE 1
+#define SERDES_MAX_PORT 4
 #define SERDES_MAX_GPIO_POWERUP_SEQ 4
 #define LOOP_SIZE 10
 
@@ -26,7 +27,7 @@ int get_sensor_pdata(struct device *dev,
 			int sensor_physical_addr,
 			int link_freq);
 
-struct ipu7_isys_subdev_pdata *get_acpi_subdev_pdata(void);
+struct ipu_isys_subdev_pdata *get_acpi_subdev_pdata(void);
 
 struct sensor_platform_data {
 	unsigned int port;
@@ -34,11 +35,11 @@ struct sensor_platform_data {
 	uint32_t i2c_slave_address;
 	int irq_pin;
 	unsigned int irq_pin_flags;
-	char irq_pin_name[IPU7_SPDATA_IRQ_PIN_NAME_LEN];
+	char irq_pin_name[IPU_SPDATA_IRQ_PIN_NAME_LEN];
 	int reset_pin;
 	int detect_pin;
 	char suffix;
-	int gpios[IPU7_SPDATA_GPIO_NUM];
+	int gpios[IPU_SPDATA_GPIO_NUM];
 };
 
 struct serdes_platform_data {
diff --git a/ipu7-drivers/include/media/ipu-acpi.h b/ipu7-drivers/include/media/ipu-acpi.h
index bc63240..1f8e09e 100644
--- a/ipu7-drivers/include/media/ipu-acpi.h
+++ b/ipu7-drivers/include/media/ipu-acpi.h
@@ -16,16 +16,53 @@
 #ifndef MEDIA_INTEL_IPU_ACPI_H
 #define MEDIA_INTEL_IPU_ACPI_H
 
-#include "ipu7-isys.h"
+#include <linux/clkdev.h>
+#include <linux/i2c.h>
+
+#include <media/v4l2-mediabus.h>
+
+struct ipu_isys_csi2_config {
+	unsigned int nlanes;
+	unsigned int port;
+	enum v4l2_mbus_type bus_type;
+};
+
+struct ipu_isys_subdev_i2c_info {
+	struct i2c_board_info board_info;
+	int i2c_adapter_id;
+	char i2c_adapter_bdf[32];
+};
+
+struct ipu_isys_subdev_info {
+	struct ipu_isys_csi2_config *csi2;
+	struct ipu_isys_subdev_i2c_info i2c;
+#if IS_ENABLED(CONFIG_INTEL_IPU_ACPI)
+	char *acpi_hid;
+#endif
+};
+
+struct ipu_isys_clk_mapping {
+	struct clk_lookup clkdev_data;
+	char *platform_clock_name;
+};
+
+struct ipu_isys_subdev_pdata {
+	struct ipu_isys_subdev_info **subdevs;
+	struct ipu_isys_clk_mapping *clk_map;
+};
 
 #define MAX_ACPI_SENSOR_NUM	4
 #define MAX_ACPI_I2C_NUM	12
 #define MAX_ACPI_GPIO_NUM	12
 
 #define GPIO_RESET		0x0
+#define GPIO_POWER_EN		0xb
+#define GPIO_READY_STAT		0x13
+
+#define IPU_SPDATA_GPIO_NUM	4
+#define IPU_SPDATA_IRQ_PIN_NAME_LEN 16
 
-#define IPU7_SPDATA_GPIO_NUM 	4
-#define IPU7_SPDATA_IRQ_PIN_NAME_LEN 16
+void set_built_in_pdata(struct ipu_isys_subdev_pdata *pdata);
 
 enum connection_type {
 	TYPE_DIRECT,
@@ -122,6 +159,11 @@ struct ipu_gpio_info {
 	bool valid;
 };
 
+struct ipu_irq_info {
+	int irq_pin;
+	char irq_pin_name[IPU_SPDATA_IRQ_PIN_NAME_LEN];
+};
+
 /* Each I2C client linked to 1 set of CTL Logic */
 struct control_logic_data {
 	struct device *dev;
@@ -133,9 +175,7 @@ struct control_logic_data {
 	bool completed;
 };
 
-int ipu_get_acpi_devices(void **spdata);
-
-struct ipu7_isys_subdev_pdata *get_built_in_pdata(void);
+struct ipu_isys_subdev_pdata *get_built_in_pdata(void);
 
 int ipu_acpi_get_cam_data(struct device *dev,
 				struct sensor_bios_data *sensor);
@@ -146,17 +186,29 @@ int ipu_acpi_get_dep_data(struct device *dev,
 int ipu_acpi_get_control_logic_data(struct device *dev,
 				struct control_logic_data **ctl_data);
 
+struct intel_ipu6_regulator {
+	char *src_dev_name;
+	char *src_rail;
+	char *dest_rail;
+};
+
 struct ipu_i2c_helper {
 	int (*fn)(struct device *dev, void *priv,
-		struct ipu7_isys_csi2_config *csi2,
+		struct ipu_isys_csi2_config *csi2,
 		bool reprobe);
 	void *driver_data;
 };
 
+struct ipu_i2c_new_dev {
+	struct list_head list;
+	struct i2c_board_info info;
+	unsigned short int bus;
+};
+
 struct ipu_camera_module_data {
 	struct list_head list;
-	struct ipu7_isys_subdev_info sd;
-	struct ipu7_isys_csi2_config csi2;
+	struct ipu_isys_subdev_info sd;
+	struct ipu_isys_csi2_config csi2;
 	unsigned int ext_clk;
 	void *pdata; /* Ptr to generated platform data*/
 	void *priv; /* Private for specific subdevice */
-- 
2.43.0

