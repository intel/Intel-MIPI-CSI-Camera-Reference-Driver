From 8b60cd4f3bd091dee52e1e1d2a00c8a5326f09d9 Mon Sep 17 00:00:00 2001
From: linya14x <linx.yang@intel.com>
Date: Mon, 12 Jan 2026 05:43:14 -0700
Subject: [PATCH 08/28] media: ipu: Dma sync at buffer_prepare callback as DMA
 is non-coherent

Test Platform:
MTL ARL LT6911UXE

Signed-off-by: linya14x <linx.yang@intel.com>
Signed-off-by: Bingbu Cao <bingbu.cao@intel.com>
---
 6.12.0/drivers/media/pci/intel/ipu6/ipu6-isys-queue.c | 5 +++++
 1 file changed, 5 insertions(+)

diff --git a/6.12.0/drivers/media/pci/intel/ipu6/ipu6-isys-queue.c b/6.12.0/drivers/media/pci/intel/ipu6/ipu6-isys-queue.c
index 69fde84..b931c43 100644
--- a/6.12.0/drivers/media/pci/intel/ipu6/ipu6-isys-queue.c
+++ b/6.12.0/drivers/media/pci/intel/ipu6/ipu6-isys-queue.c
@@ -84,7 +84,9 @@ static int ipu6_isys_queue_setup(struct vb2_queue *q, unsigned int *num_buffers,
 static int ipu6_isys_buf_prepare(struct vb2_buffer *vb)
 {
 	struct ipu6_isys_queue *aq = vb2_queue_to_isys_queue(vb->vb2_queue);
+	struct ipu6_isys *isys = vb2_get_drv_priv(vb->vb2_queue);
 	struct ipu6_isys_video *av = ipu6_isys_queue_to_video(aq);
+	struct sg_table *sg = vb2_dma_sg_plane_desc(vb, 0);
 	struct device *dev = &av->isys->adev->auxdev.dev;
 	u32 bytesperline = ipu6_isys_get_bytes_per_line(av);
 	u32 height = ipu6_isys_get_frame_height(av);
@@ -98,6 +100,9 @@ static int ipu6_isys_buf_prepare(struct vb2_buffer *vb)
 
 	vb2_set_plane_payload(vb, 0, bytesperline * height);
 
+	/* assume IPU is not DMA coherent */
+	ipu6_dma_sync_sgtable(isys->adev, sg);
+
 	return 0;
 }
 
-- 
2.43.0

