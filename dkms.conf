PACKAGE_NAME="intel-mipi-gmsl-dkms"
PACKAGE_VERSION="#MODULE_VERSION#"
BUILD_EXCLUSIVE_KERNEL="^(6\.(1[278])\.)"
VERSION_SUFFIX="${PACKAGE_VERSION}"

KBASE=${dkms_tree}/${PACKAGE_NAME}/${PACKAGE_VERSION}/build
#Extract kernel version substring that is used to identify source directory for kernel modules
# i.e 4.4.0-116-generic ==>  4.4.0
SELECTED_KERNEL=$(echo $kernelver | cut -d- -f1 | sed -r 's/(.*?)\..*/\1.0/g')
SELECTED_KERNEL_PATCH=$(echo $kernelver | cut -d- -f2)
VERSION=$(echo $kernelver | sed -ne 's/\([0-9]\+\)\.\([0-9]\+\)\.\([0-9]\+\)\-\(.\+\)/\1/p')
PATCHLEVEL=$(echo $kernelver | sed -ne 's/\([0-9]\+\)\.\([0-9]\+\)\.\([0-9]\+\)\-\(.\+\)/\2/p')
SUBLEVEL=$(echo $kernelver | sed -ne 's/\([0-9]\+\)\.\([0-9]\+\)\.\([0-9]\+\)\-\(.\+\)/\3/p')

#This variable is required to address includes from videodev.ko
srctree=${dkms_tree}/${PACKAGE_NAME}/${PACKAGE_VERSION}/build

#We will invoke multiple make directives to build all the required kernel modules, then manually copy them to the staged directory for dkms install rule
MAKE="make V=1 KERNELRELEASE=$kernelver DRIVER_VERSION_SUFFIX='${VERSION_SUFFIX}' KERNEL_SRC=$kernel_source_dir && \
	if [ -d ${KBASE}/drivers/media/v4l2-core ]; then rmdir ${KBASE}/drivers/media/v4l2-core ; fi &&\
		 make V=1 -C ${kernel_source_dir} M=${KBASE}/${SELECTED_KERNEL}/drivers/media/v4l2-core videodev.ko DRIVER_VERSION_SUFFIX='${VERSION_SUFFIX}' &&\
		 mkdir -p ${KBASE}/drivers/media/v4l2-core/ && cp ${KBASE}/${SELECTED_KERNEL}/drivers/media/v4l2-core/videodev.ko ${KBASE}/drivers/media/v4l2-core/ && \
	if [ -d ${KBASE}/drivers/media/pci/intel/ipu6 ]; then rmdir ${KBASE}/drivers/media/pci/intel/ipu6 ; fi &&\
		 make V=1 -C ${kernel_source_dir} M=${KBASE}/${SELECTED_KERNEL}/drivers/media/pci/intel/ipu6 DRIVER_VERSION_SUFFIX='${VERSION_SUFFIX}' && \
		 mkdir -p ${KBASE}/drivers/media/pci/intel/ipu6/ && cp ${KBASE}/${SELECTED_KERNEL}/drivers/media/pci/intel/ipu6/intel-ipu6.ko  ${KBASE}/${SELECTED_KERNEL}/drivers/media/pci/intel/ipu6/intel-ipu6-isys.ko ${KBASE}/${SELECTED_KERNEL}/drivers/media/pci/intel/ipu6/psys/intel-ipu6-psys.ko ${KBASE}/drivers/media/pci/intel/ipu6/"

MAKE_MATCH[1]="^(6.1[27])"

CLEAN="make V=1 KERNELRELEASE=$kernelver KERNEL_SRC=$kernel_source_dir clean && \
	    make -C ${kernel_source_dir} M=${KBASE}/${SELECTED_KERNEL}/drivers/media/v4l2-core clean clean && \
	    make -C ${kernel_source_dir} M=${KBASE}/${SELECTED_KERNEL}/drivers/media/pci/intel/ipu6 clean"

AUTOINSTALL="yes"

# Add non-upstreamed ISYS patches for Kernel 6.12
PATCH[0]="0001-media-intel-ipu6-Fix-dma-mask-for-non-secure-mode.patch"
PATCH[1]="0002-media-ipu6-Remove-workaround-for-Meteor-Lake-ES2.patch"
PATCH[2]="0003-media-intel-ipu6-remove-buttress-ish-structure.patch"
PATCH[3]="0004-upstream-Use-module-parameter-to-set-isys-freq.patch"
PATCH[4]="0005-media-pci-Enable-ISYS-reset.patch"
PATCH[5]="0006-media-intel-ipu6-remove-buttress-ish-structure.patch"
PATCH[6]="0007-media-intel-ipu6-use-vc1-dma-for-MTL-and-ARL.patch"
PATCH[7]="0008-media-ipu-Dma-sync-at-buffer_prepare-callback-as-DMA.patch"
PATCH[8]="0009-media-intel-ipu6-support-IPU6-ISYS-FW-trace-dump-for.patch"
PATCH[9]="0010-media-pci-The-order-of-return-buffers-should-be-FIFO.patch"
PATCH[10]="0011-media-pci-Modify-enble-disable-stream-in-CSI2.patch"
PATCH[11]="0012-media-pci-Set-the-correct-SOF-for-different-stream.patch"
PATCH[12]="0013-media-intel-ipu6-support-imx390-for-6.11.0-rc3.patch"
PATCH[13]="0014-media-intel-ipu6-fix-coverity-issue.patch"
PATCH[14]="0015-media-intel-ipu6-move-ipu-acpi-module-to-linux-drive.patch"
PATCH[15]="0016-media-pci-unregister-i2c-device-to-complete-ext_subd.patch"
PATCH[16]="0017-media-pci-add-missing-if-for-PDATA.patch"
PATCH[17]="0018-media-pci-refine-PDATA-related-config.patch"
PATCH[18]="0019-media-intel-ipu6-align-ACPI-PDATA-and-ACPI-fwnode-bu.patch"
PATCH_MATCH[0]="^(6.1[2])"
PATCH_MATCH[1]="^(6.1[2])"
PATCH_MATCH[2]="^(6.1[2])"
PATCH_MATCH[3]="^(6.1[2])"
PATCH_MATCH[4]="^(6.1[2])"
PATCH_MATCH[5]="^(6.1[2])"
PATCH_MATCH[6]="^(6.1[2])"
PATCH_MATCH[7]="^(6.1[2])"
PATCH_MATCH[8]="^(6.1[2])"
PATCH_MATCH[9]="^(6.1[2])"
PATCH_MATCH[10]="^(6.1[2])"
PATCH_MATCH[11]="^(6.1[2])"
PATCH_MATCH[12]="^(6.1[2])"
PATCH_MATCH[13]="^(6.1[2])"
PATCH_MATCH[14]="^(6.1[2])"
PATCH_MATCH[15]="^(6.1[2])"
PATCH_MATCH[16]="^(6.1[2])"
PATCH_MATCH[17]="^(6.1[2])"
PATCH_MATCH[18]="^(6.1[2])"
# Add out-of-tree PSYS codebase
PATCH[19]="0020-upstream-Use-module-parameter-to-set-psys-freq.patch"
PATCH[20]="0021-media-pci-update-IPU6-PSYS-driver.patch"
PATCH[21]="0022-media-intel-ipu6-support-IPU6-PSYS-FW-trace-dump-for.patch"
PATCH_MATCH[19]="^(6.1[2])"
PATCH_MATCH[20]="^(6.1[2])"
PATCH_MATCH[21]="^(6.1[2])"
# Make IPU V4L2-CORE out-of-tree
PATCH[22]="0023-ipu7-dkms-v4l2-core-makefile-adaptation-6.12.patch"
PATCH[23]="0024-drivers-media-set-v4l2_subdev_enable_streams_api-tru.patch"
PATCH_MATCH[22]="^(6.1[2])"
PATCH_MATCH[23]="^(6.1[2])"
# Make IPU ISYS+PSYS out-of-tree
PATCH[24]="0025-ipu6-dkms-add-isys-makefile-adaptation-6.12.patch"
PATCH[25]="0026-ipu6-dkms-align-ipu7-acpi-pdata-device-parser-on-6.1.patch"
PATCH_MATCH[24]="^(6.1[2])"
PATCH_MATCH[25]="^(6.1[2])"


j=25

# Linux non-upstreamed patches for Linux 6.17 to 6.18
PATCH[$((++j))]="0050-media-ipu6-isys-Use-v4l2_ctrl_subdev_subscribe_event.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0051-media-ipu6-isys-Don-t-set-V4L2_FL_USES_V4L2_FH-manua.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0052-media-ipu6-isys-Set-embedded-data-type-correctly-for.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0053-upstream-Use-module-parameter-to-set-isys-freq.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0054-media-pci-Enable-ISYS-reset.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0055-media-intel-ipu6-use-vc1-dma-for-MTL-and-ARL.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0056-media-ipu-Dma-sync-at-buffer_prepare-callback-as-DMA.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0057-media-intel-ipu6-Support-IPU6-ISYS-FW-trace-dump-for.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0058-media-pci-The-order-of-return-buffers-should-be-FIFO.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0059-media-pci-Modify-enble-disable-stream-in-CSI2.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0060-media-pci-Set-the-correct-SOF-for-different-stream.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0061-media-pci-support-imx390-for-6.11.0-rc3.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0062-i2c-media-fix-cov-issue.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0063-media-add-ipu-acpi-module-to-linux-drivers.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0064-media-pci-unregister-i2c-device-to-complete-ext_subd.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0065-media-pci-add-missing-if-for-PDATA.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0066-media-pci-refine-PDATA-related-config.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0067-kernel-align-ACPI-PDATA-and-ACPI-fwnode-build-for-EC.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0068-upstream-Use-module-parameter-to-set-psys-freq.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0069-media-pci-add-IPU6-PSYS-driver.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0070-media-intel-ipu6-support-IPU6-PSYS-FW-trace-dump-for.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0071-Revert-media-intel-ipu6-Constify-ipu6_buttress_ctrl-.patch"
PATCH_MATCH[$j]="^(6.1[78])"
# Make IPU V4L2-CORE out-of-tree
PATCH[$((++j))]="0072-ipu7-dkms-v4l2-core-makefile-adaptation-6.17.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0073-drivers-media-set-v4l2_subdev_enable_streams_api-tru.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0074-ipu7-dkms-v4l2-core-makefile-adaptation-6.18.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0075-drivers-media-set-v4l2_subdev_enable_streams_api-tru.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0076-Revert-media-v4l2-subdev-Make-struct-v4l2_subdev_str.patch"
PATCH_MATCH[$j]="^(6.1[78])"
# Make IPU ISYS+PSYS out-of-tree
PATCH[$((++j))]="0077-ipu6-dkms-add-isys-makefile-adaptation-6.17.patch"
PATCH_MATCH[$j]="^(6.1[78])"
PATCH[$((++j))]="0078-ipu6-dkms-align-ipu7-acpi-pdata-device-parser-on-6.1.patch"
PATCH_MATCH[$j]="^(6.1[78])"

i=0

BUILT_MODULE_NAME[$i]="videodev"
BUILT_MODULE_LOCATION[$i]="drivers/media/v4l2-core/"
DEST_MODULE_NAME[$i]="videodev"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="intel-ipu6"
BUILT_MODULE_LOCATION[$i]="drivers/media/pci/intel/ipu6"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="intel-ipu6-isys"
BUILT_MODULE_LOCATION[$i]="drivers/media/pci/intel/ipu6"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="intel-ipu6-psys"
BUILT_MODULE_LOCATION[$i]="drivers/media/pci/intel/ipu6"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="ipu-acpi"
BUILT_MODULE_LOCATION[$i]="drivers/media/platform/intel"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="ipu-acpi-pdata"
BUILT_MODULE_LOCATION[$i]="drivers/media/platform/intel"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="ipu-acpi-common"
BUILT_MODULE_LOCATION[$i]="drivers/media/platform/intel"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="ar0234"
BUILT_MODULE_LOCATION[$i]="drivers/media/i2c"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="ar0234"
BUILT_MODULE_LOCATION[$i]="drivers/media/i2c"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="ar0820"
BUILT_MODULE_LOCATION[$i]="drivers/media/i2c"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="ipu-bridge"
BUILT_MODULE_LOCATION[$i]="drivers/media/pci/intel"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="isx031"
BUILT_MODULE_LOCATION[$i]="drivers/media/i2c"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no
