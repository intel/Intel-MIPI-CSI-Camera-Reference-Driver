PACKAGE_NAME="intel-mipi-gmsl-dkms"
PACKAGE_VERSION="#MODULE_VERSION#"
BUILD_EXCLUSIVE_KERNEL="^(6\.(1[7])\.)"
VERSION_SUFFIX="${PACKAGE_VERSION}"

KBASE=${dkms_tree}/${PACKAGE_NAME}/${PACKAGE_VERSION}/build
#Extract kernel version substring that is used to identify source directory for kernel modules
# i.e 4.4.0-116-generic ==>  4.4.0
SELECTED_KERNEL=$(echo $kernelver | cut -d- -f1 | sed -r 's/(.*?)\..*/\1.0/g')
SELECTED_KERNEL_PATCH=$(echo $kernelver | cut -d- -f2)
VERSION=$(echo $kernelver | sed -ne 's/\([0-9]\+\)\.\([0-9]\+\)\.\([0-9]\+\)\-\(.\+\)/\1/p')
PATCHLEVEL=$(echo $kernelver | sed -ne 's/\([0-9]\+\)\.\([0-9]\+\)\.\([0-9]\+\)\-\(.\+\)/\2/p')
SUBLEVEL=$(echo $kernelver | sed -ne 's/\([0-9]\+\)\.\([0-9]\+\)\.\([0-9]\+\)\-\(.\+\)/\3/p')

#This variable is required to address includes from videodev.ko
srctree=${dkms_tree}/${PACKAGE_NAME}/${PACKAGE_VERSION}/build

#We will invoke multiple make directives to build all the required kernel modules, then manually copy them to the staged directory for dkms install rule
MAKE="make V=1 KERNELRELEASE=$kernelver DRIVER_VERSION_SUFFIX='${VERSION_SUFFIX}' KERNEL_SRC=$kernel_source_dir && \
	if [ -d ${KBASE}/drivers/media/v4l2-core ]; then rmdir ${KBASE}/drivers/media/v4l2-core ; fi &&\
		 make V=1 -C ${kernel_source_dir} M=${KBASE}/${SELECTED_KERNEL}/drivers/media/v4l2-core videodev.ko DRIVER_VERSION_SUFFIX='${VERSION_SUFFIX}' &&\
		 mkdir -p ${KBASE}/drivers/media/v4l2-core/ && cp ${KBASE}/${SELECTED_KERNEL}/drivers/media/v4l2-core/videodev.ko ${KBASE}/drivers/media/v4l2-core/ && \
	if [ -d ${KBASE}/drivers/media/pci/intel/ipu6 ]; then rmdir ${KBASE}/drivers/media/pci/intel/ipu6 ; fi &&\
		 make V=1 -C ${kernel_source_dir} M=${KBASE}/${SELECTED_KERNEL}/drivers/media/pci/intel/ipu6 intel-ipu6-isys.ko intel-ipu6.ko DRIVER_VERSION_SUFFIX='${VERSION_SUFFIX}' && \
		 mkdir -p ${KBASE}/drivers/media/pci/intel/ipu6/ && cp ${KBASE}/${SELECTED_KERNEL}/drivers/media/pci/intel/ipu6/intel-ipu6.ko ${KBASE}/drivers/media/pci/intel/ipu6/ && cp ${KBASE}/${SELECTED_KERNEL}/drivers/media/pci/intel/ipu6/intel-ipu6-isys.ko ${KBASE}/drivers/media/pci/intel/ipu6/"

MAKE_MATCH[1]="^(6.1[7])"

CLEAN="make V=1 KERNELRELEASE=$kernelver KERNEL_SRC=$kernel_source_dir clean && \
	    make -C ${kernel_source_dir} M=${KBASE}/${SELECTED_KERNEL}/drivers/media/v4l2-core clean clean && \
	    make -C ${kernel_source_dir} M=${KBASE}/${SELECTED_KERNEL}/drivers/media/pci/intel/ipu6 clean"

AUTOINSTALL="yes"

#Patches for Kernel 6.17
PATCH[0]="0001-ipu7-dkms-v4l2-core-makefile-adaptation-6.17.patch"
PATCH[1]="0002-drivers-media-set-v4l2_subdev_enable_streams_api-tru.patch"
PATCH[2]="0003-ipu6-dkms-add-isys-makefile-adaptation-6.17.patch"
PATCH_MATCH[0]="^(6.1[7])"
PATCH_MATCH[1]="^(6.1[7])"
PATCH_MATCH[2]="^(6.1[7])"

i=0

BUILT_MODULE_NAME[$i]="videodev"
BUILT_MODULE_LOCATION[$i]="drivers/media/v4l2-core/"
DEST_MODULE_NAME[$i]="videodev"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="intel-ipu6"
BUILT_MODULE_LOCATION[$i]="drivers/media/pci/intel/ipu6"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="intel-ipu6-isys"
BUILT_MODULE_LOCATION[$i]="drivers/media/pci/intel/ipu6"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="ipu-acpi"
BUILT_MODULE_LOCATION[$i]="drivers/media/platform/intel"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="ipu-acpi-pdata"
BUILT_MODULE_LOCATION[$i]="drivers/media/platform/intel"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="ipu-acpi-common"
BUILT_MODULE_LOCATION[$i]="drivers/media/platform/intel"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="ar0234"
BUILT_MODULE_LOCATION[$i]="drivers/media/i2c"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="ar0234"
BUILT_MODULE_LOCATION[$i]="drivers/media/i2c"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="ar0820"
BUILT_MODULE_LOCATION[$i]="drivers/media/i2c"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="ipu-bridge"
BUILT_MODULE_LOCATION[$i]="drivers/media/pci/intel"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no

BUILT_MODULE_NAME[$((++i))]="isx031"
BUILT_MODULE_LOCATION[$i]="drivers/media/i2c"
DEST_MODULE_LOCATION[$i]="/updates"
STRIP[$i]=no
